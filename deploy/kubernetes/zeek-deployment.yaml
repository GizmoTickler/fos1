apiVersion: v1
kind: Namespace
metadata:
  name: security-monitoring
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: zeek-config
  namespace: security-monitoring
data:
  local.zeek: |
    ##! Local site policy. Customize as appropriate.
    ##!
    ##! This file will not be overwritten when upgrading or reinstalling!

    # This script logs which scripts were loaded during each run.
    @load misc/loaded-scripts

    # Apply the default tuning scripts for common tuning settings.
    @load tuning/defaults

    # Load the scan detection script.
    @load misc/scan

    # Log some information about web applications being used.
    @load misc/app-stats

    # Detect traceroute being run on the network.
    @load misc/detect-traceroute

    # Generate notices when vulnerable versions of software are discovered.
    @load frameworks/software/vulnerable

    # Detect software changing (e.g. attacker installing hacked SSHD).
    @load frameworks/software/version-changes

    # This adds signatures to detect cleartext forward and reverse shell sessions.
    @load-sigs frameworks/signatures/detect-shellshock

    # Load all of the scripts that detect software in various protocols.
    @load protocols/ftp/software
    @load protocols/smtp/software
    @load protocols/ssh/software
    @load protocols/http/software

    # Load all of the scripts that detect malware in various protocols.
    @load-sigs frameworks/signatures/detect-windows-shells

    # Uncomment the following line to enable detection of the heartbleed attack.
    @load policy/protocols/ssl/heartbleed

    # Uncomment the following line to enable logging of connection VLANs.
    @load policy/protocols/conn/vlan-logging

    # Uncomment the following line to enable logging of BPF filter expressions.
    @load policy/frameworks/packet-filter/log-packets

    # Enable JSON logging for easier integration
    @load policy/tuning/json-logs.zeek
    redef LogAscii::use_json = T;

    # Load custom DPI Framework scripts
    @load site/dpi-framework/load-scripts
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: zeek-custom-scripts
  namespace: security-monitoring
data:
  load-scripts.zeek: |
    ##! Main script to load all custom scripts

    # Load base protocols
    @load base/protocols/conn
    @load base/protocols/http
    @load base/protocols/dns
    @load base/protocols/ssl
    @load base/protocols/ssh
    @load base/protocols/smtp
    @load base/protocols/ftp

    # Load VLAN logging
    @load policy/protocols/conn/vlan-logging

    # Load custom scripts
    @load ./app-detection
    @load ./vlan-processing

    # Print a message when scripts are loaded
    event zeek_init() {
        print "Loaded custom DPI Framework scripts";
    }

  app-detection.zeek: |
    ##! Script for enhanced application detection
    ##! This script adds additional application detection capabilities to Zeek

    @load base/protocols/conn
    @load base/protocols/http
    @load base/protocols/dns
    @load base/protocols/ssl
    @load base/protocols/ssh
    @load policy/protocols/conn/vlan-logging

    module AppDetection;

    export {
        # Define new application types
        const APP_NETFLIX = "netflix" &redef;
        const APP_YOUTUBE = "youtube" &redef;
        const APP_ZOOM = "zoom" &redef;
        const APP_PLEX = "plex" &redef;
        const APP_SPOTIFY = "spotify" &redef;
        const APP_HULU = "hulu" &redef;
        const APP_AMAZON = "amazon-video" &redef;
        const APP_DISNEY = "disney-plus" &redef;

        # Add to the connection record
        redef record Conn::Info += {
            app: string &optional &log;
            vlan: int &optional &log;
        };
    }

    # Netflix detection
    event http_header(c: connection, is_orig: bool, name: string, value: string) {
        if (name == "HOST" && /netflix\.com/ in value) {
            c$conn$app = APP_NETFLIX;
        }
    }

    # YouTube detection
    event http_header(c: connection, is_orig: bool, name: string, value: string) {
        if (name == "HOST" && /youtube\.com/ in value) {
            c$conn$app = APP_YOUTUBE;
        }
        else if (name == "HOST" && /youtu\.be/ in value) {
            c$conn$app = APP_YOUTUBE;
        }
    }

    # Zoom detection
    event ssl_established(c: connection) {
        if (c$ssl?$server_name && /zoom\.us/ in c$ssl$server_name) {
            c$conn$app = APP_ZOOM;
        }
    }

    # VLAN logging
    event connection_state_remove(c: connection) {
        if (c?$vlan) {
            c$conn$vlan = c$vlan;
        }
    }

  vlan-processing.zeek: |
    ##! Script for VLAN-specific processing
    ##! This script adds VLAN-aware processing to Zeek

    @load base/protocols/conn
    @load policy/protocols/conn/vlan-logging
    @load ./app-detection

    module VLANProcessing;

    export {
        # Define VLAN configurations
        type VLANConfig: record {
            id: count;
            name: string;
            subnet: subnet;
            default_policy: string;
            applications: set[string];
        };

        # Global table of VLAN configurations
        global vlan_configs: table[count] of VLANConfig;

        # Initialize VLAN configurations
        global initialize_vlan_configs: function();
    }

    # Initialize VLAN configurations
    function initialize_vlan_configs() {
        # IoT VLAN
        local iot_vlan: VLANConfig = [$id=10,
                                     $name="iot",
                                     $subnet=192.168.10.0/24,
                                     $default_policy="restrict",
                                     $applications=set("mqtt", "http", "dns")];
        vlan_configs[10] = iot_vlan;

        # Media VLAN
        local media_vlan: VLANConfig = [$id=20,
                                       $name="media",
                                       $subnet=192.168.20.0/24,
                                       $default_policy="allow",
                                       $applications=set("rtsp", "rtmp", "http", "https")];
        vlan_configs[20] = media_vlan;

        # Guest VLAN
        local guest_vlan: VLANConfig = [$id=30,
                                       $name="guest",
                                       $subnet=192.168.30.0/24,
                                       $default_policy="deny",
                                       $applications=set("http", "https", "dns")];
        vlan_configs[30] = guest_vlan;
    }

    # Check if an application is allowed on a VLAN
    function is_application_allowed(vlan_id: count, app: string): bool {
        if (vlan_id !in vlan_configs) {
            return T;  # If VLAN not configured, allow by default
        }

        local config = vlan_configs[vlan_id];

        # If no applications specified, allow all
        if (|config$applications| == 0) {
            return T;
        }

        # Check if application is in allowed list
        if (app in config$applications) {
            return T;
        }

        # Default policy
        if (config$default_policy == "allow") {
            return T;
        } else if (config$default_policy == "deny") {
            return F;
        } else {  # restrict
            return F;
        }
    }

    # Initialize VLAN configurations when Zeek starts
    event zeek_init() {
        initialize_vlan_configs();
    }

    # Process connections with VLAN information
    event connection_state_remove(c: connection) {
        if (!c?$vlan) {
            return;
        }

        local vlan_id = c$vlan;
        local app = "";

        # Get application if available
        if (c$conn?$app) {
            app = c$conn$app;
        } else if (c$conn?$service) {
            app = c$conn$service;
        }

        # Skip if no application identified
        if (app == "") {
            return;
        }

        # Check if application is allowed on this VLAN
        local allowed = is_application_allowed(vlan_id, app);

        # Log the result
        if (!allowed) {
            local msg = fmt("Application %s not allowed on VLAN %d", app, vlan_id);
            print msg;

            # In a real implementation, this would trigger an alert or block the traffic
        }
    }
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: zeek-logs-pvc
  namespace: security-monitoring
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: zeek
  namespace: security-monitoring
  labels:
    app: zeek
spec:
  replicas: 1
  selector:
    matchLabels:
      app: zeek
  template:
    metadata:
      labels:
        app: zeek
    spec:
      # Use host network to capture traffic
      hostNetwork: true
      containers:
      - name: zeek
        image: zeek/zeek:latest
        securityContext:
          capabilities:
            add: ["NET_RAW", "NET_ADMIN"]
          privileged: true
        command:
        - "/bin/bash"
        - "-c"
        - |
          mkdir -p /opt/zeek/share/zeek/site/local
          cp /zeek-config/local.zeek /opt/zeek/share/zeek/site/local/local.zeek
          /opt/zeek/bin/zeekctl deploy
          tail -f /opt/zeek/logs/current/stderr.log
        volumeMounts:
        - name: zeek-logs
          mountPath: /opt/zeek/logs
        - name: zeek-config
          mountPath: /zeek-config
        - name: zeek-custom-scripts
          mountPath: /opt/zeek/share/zeek/site/dpi-framework
        env:
        - name: INTERFACE
          value: "eth0" # Change to the appropriate interface
        resources:
          limits:
            cpu: "2"
            memory: "4Gi"
          requests:
            cpu: "1"
            memory: "2Gi"
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - "pgrep zeek || pgrep zeekctl"
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - "test -f /opt/zeek/logs/current/conn.log"
          initialDelaySeconds: 30
          periodSeconds: 10
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: false  # Zeek needs root for packet capture
          runAsUser: 0
          capabilities:
            add: ["NET_RAW", "NET_ADMIN", "SYS_NICE"]
            drop: ["ALL"]
      volumes:
      - name: zeek-logs
        persistentVolumeClaim:
          claimName: zeek-logs-pvc
      - name: zeek-config
        configMap:
          name: zeek-config
      - name: zeek-custom-scripts
        configMap:
          name: zeek-custom-scripts
---
apiVersion: v1
kind: Service
metadata:
  name: zeek
  namespace: security-monitoring
spec:
  selector:
    app: zeek
  ports:
  - port: 9999
    targetPort: 9999
    name: zeek-api
  type: ClusterIP
