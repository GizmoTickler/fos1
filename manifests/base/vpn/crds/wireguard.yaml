apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: wireguardvpns.vpn.fos1.io
spec:
  group: vpn.fos1.io
  names:
    kind: WireGuardVPN
    listKind: WireGuardVPNList
    plural: wireguardvpns
    singular: wireguardvpn
    shortNames:
      - wgvpn
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - enabled
                - interface
              properties:
                enabled:
                  type: boolean
                  description: "Whether the WireGuard VPN is enabled"
                interface:
                  type: object
                  required:
                    - name
                    - privateKey
                    - listenPort
                  properties:
                    name:
                      type: string
                      description: "Name of the WireGuard interface"
                    privateKey:
                      type: string
                      description: "Private key for the WireGuard interface (or reference to a secret)"
                    listenPort:
                      type: integer
                      description: "UDP port to listen on"
                      minimum: 1
                      maximum: 65535
                    address:
                      type: array
                      description: "IP addresses to assign to the interface"
                      items:
                        type: string
                    dns:
                      type: array
                      description: "DNS servers to use for this interface"
                      items:
                        type: string
                    mtu:
                      type: integer
                      description: "MTU for the interface"
                      minimum: 1280
                      maximum: 9000
                    firewall:
                      type: boolean
                      description: "Whether to enable firewall rules for this interface"
                      default: true
                    table:
                      type: integer
                      description: "Routing table ID for this interface"
                      minimum: 0
                      maximum: 4294967295
                    preUp:
                      type: array
                      description: "Commands to run before interface is up"
                      items:
                        type: string
                    postUp:
                      type: array
                      description: "Commands to run after interface is up"
                      items:
                        type: string
                    preDown:
                      type: array
                      description: "Commands to run before interface is down"
                      items:
                        type: string
                    postDown:
                      type: array
                      description: "Commands to run after interface is down"
                      items:
                        type: string
                peers:
                  type: array
                  description: "WireGuard peers"
                  items:
                    type: object
                    required:
                      - publicKey
                    properties:
                      publicKey:
                        type: string
                        description: "Public key of the peer"
                      presharedKey:
                        type: string
                        description: "Preshared key for the peer (or reference to a secret)"
                      endpoint:
                        type: string
                        description: "Endpoint of the peer (IP:port)"
                      persistentKeepalive:
                        type: integer
                        description: "Persistent keepalive interval in seconds"
                        minimum: 0
                        maximum: 65535
                      allowedIPs:
                        type: array
                        description: "Allowed IPs for the peer"
                        items:
                          type: string
                      description:
                        type: string
                        description: "Description of the peer"
                routing:
                  type: object
                  properties:
                    defaultRoute:
                      type: boolean
                      description: "Whether to use this VPN as the default route"
                      default: false
                    allowedIPs:
                      type: array
                      description: "IPs to route through this VPN"
                      items:
                        type: string
                    excludedIPs:
                      type: array
                      description: "IPs to exclude from routing through this VPN"
                      items:
                        type: string
                    metric:
                      type: integer
                      description: "Metric for routes"
                      minimum: 0
                      maximum: 4294967295
                security:
                  type: object
                  properties:
                    keyRotation:
                      type: object
                      properties:
                        enabled:
                          type: boolean
                          description: "Whether to enable key rotation"
                          default: false
                        interval:
                          type: string
                          description: "Interval for key rotation (e.g., 30d)"
                    accessControl:
                      type: object
                      properties:
                        allowedIPs:
                          type: array
                          description: "IPs allowed to connect to the VPN"
                          items:
                            type: string
                        blockedIPs:
                          type: array
                          description: "IPs blocked from connecting to the VPN"
                          items:
                            type: string
                monitoring:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      description: "Whether to enable monitoring"
                      default: true
                    metrics:
                      type: boolean
                      description: "Whether to collect metrics"
                      default: true
                    logging:
                      type: boolean
                      description: "Whether to enable logging"
                      default: true
                    logLevel:
                      type: string
                      description: "Log level"
                      enum: ["debug", "info", "warn", "error"]
                      default: "info"
            status:
              type: object
              properties:
                phase:
                  type: string
                  description: "Current phase of the VPN (Pending, Running, Failed)"
                publicKey:
                  type: string
                  description: "Public key derived from the private key"
                connectedPeers:
                  type: integer
                  description: "Number of connected peers"
                lastHandshake:
                  type: string
                  format: date-time
                  description: "Time of the last handshake"
                transferRx:
                  type: integer
                  description: "Bytes received"
                transferTx:
                  type: integer
                  description: "Bytes transmitted"
                conditions:
                  type: array
                  items:
                    type: object
                    required:
                      - type
                      - status
                    properties:
                      type:
                        type: string
                        description: "Condition type"
                      status:
                        type: string
                        description: "Condition status"
                      reason:
                        type: string
                        description: "Reason for the condition"
                      message:
                        type: string
                        description: "Message for the condition"
                      lastTransitionTime:
                        type: string
                        format: date-time
                        description: "Last transition time"
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Enabled
          type: boolean
          jsonPath: .spec.enabled
        - name: Interface
          type: string
          jsonPath: .spec.interface.name
        - name: Listen Port
          type: integer
          jsonPath: .spec.interface.listenPort
        - name: Peers
          type: integer
          jsonPath: .status.connectedPeers
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
