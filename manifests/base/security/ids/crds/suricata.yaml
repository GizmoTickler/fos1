apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: suricatainstances.security.fos1.io
spec:
  group: security.fos1.io
  names:
    kind: SuricataInstance
    listKind: SuricataInstanceList
    plural: suricatainstances
    singular: suricatainstance
    shortNames:
      - suri
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - interfaces
              properties:
                mode:
                  type: string
                  description: "Mode of operation (IDS or IPS)"
                  enum: ["IDS", "IPS"]
                  default: "IDS"
                interfaces:
                  type: array
                  description: "Network interfaces to monitor"
                  items:
                    type: object
                    required:
                      - name
                    properties:
                      name:
                        type: string
                        description: "Name of the interface"
                      promiscuous:
                        type: boolean
                        description: "Whether to use promiscuous mode"
                        default: true
                      bpfFilter:
                        type: string
                        description: "BPF filter for the interface"
                      checksum:
                        type: boolean
                        description: "Whether to validate checksums"
                        default: true
                      threadCount:
                        type: integer
                        description: "Number of threads to use"
                        minimum: 1
                        default: 1
                ruleSources:
                  type: array
                  description: "Sources for Suricata rules"
                  items:
                    type: object
                    required:
                      - name
                      - url
                    properties:
                      name:
                        type: string
                        description: "Name of the rule source"
                      url:
                        type: string
                        description: "URL of the rule source"
                      enabled:
                        type: boolean
                        description: "Whether the source is enabled"
                        default: true
                      categories:
                        type: array
                        description: "Categories to include"
                        items:
                          type: string
                      excludedCategories:
                        type: array
                        description: "Categories to exclude"
                        items:
                          type: string
                customRules:
                  type: array
                  description: "Custom Suricata rules"
                  items:
                    type: string
                disabledRules:
                  type: array
                  description: "IDs of disabled rules"
                  items:
                    type: string
                resources:
                  type: object
                  description: "Resource requirements"
                  properties:
                    limits:
                      type: object
                      properties:
                        cpu:
                          type: string
                          pattern: '^([0-9]+m|[0-9]+(\.[0-9]+)?)$'
                        memory:
                          type: string
                          pattern: '^([0-9]+(e[0-9]+)?|[0-9]+(\.[0-9]+)?(e[0-9]+)?[EPTGMK]i?)$'
                    requests:
                      type: object
                      properties:
                        cpu:
                          type: string
                          pattern: '^([0-9]+m|[0-9]+(\.[0-9]+)?)$'
                        memory:
                          type: string
                          pattern: '^([0-9]+(e[0-9]+)?|[0-9]+(\.[0-9]+)?(e[0-9]+)?[EPTGMK]i?)$'
                detectionEngineProfile:
                  type: string
                  description: "Detection engine profile"
                  enum: ["low", "medium", "high", "custom"]
                  default: "medium"
                memoryProfile:
                  type: string
                  description: "Memory profile"
                  enum: ["low", "medium", "high", "custom"]
                  default: "medium"
                maxPendingPackets:
                  type: integer
                  description: "Maximum number of pending packets"
                  minimum: 1000
                  default: 10000
                statsInterval:
                  type: string
                  description: "Interval for statistics (e.g., 10s, 1m)"
                  default: "10s"
                logLevel:
                  type: string
                  description: "Log level"
                  enum: ["error", "warning", "notice", "info", "debug"]
                  default: "info"
                hostNetwork:
                  type: boolean
                  description: "Whether to use host network"
                  default: true
                nodeSelector:
                  type: object
                  description: "Node selector for deployment"
                  additionalProperties:
                    type: string
            status:
              type: object
              properties:
                phase:
                  type: string
                  description: "Current phase of the instance"
                  enum: ["Pending", "Running", "Failed"]
                conditions:
                  type: array
                  description: "Current conditions of the instance"
                  items:
                    type: object
                    required:
                      - type
                      - status
                    properties:
                      type:
                        type: string
                        description: "Type of the condition"
                      status:
                        type: string
                        description: "Status of the condition"
                        enum: ["True", "False", "Unknown"]
                      reason:
                        type: string
                        description: "Reason for the condition"
                      message:
                        type: string
                        description: "Message for the condition"
                      lastTransitionTime:
                        type: string
                        format: date-time
                        description: "Last time the condition transitioned"
                rulesLastUpdated:
                  type: string
                  format: date-time
                  description: "Time when the rules were last updated"
                rulesCount:
                  type: integer
                  description: "Number of loaded rules"
                uptime:
                  type: string
                  description: "Uptime of the instance"
                lastRestart:
                  type: string
                  format: date-time
                  description: "Time of the last restart"
                alertsGenerated:
                  type: integer
                  description: "Number of alerts generated"
                interfaceStats:
                  type: object
                  description: "Statistics per interface"
                  additionalProperties:
                    type: object
                    properties:
                      packetsReceived:
                        type: integer
                        description: "Number of packets received"
                      packetsDropped:
                        type: integer
                        description: "Number of packets dropped"
                      bytesReceived:
                        type: integer
                        description: "Number of bytes received"
                      alertsGenerated:
                        type: integer
                        description: "Number of alerts generated"
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Mode
          type: string
          jsonPath: .spec.mode
        - name: Interfaces
          type: string
          jsonPath: .spec.interfaces[*].name
        - name: Status
          type: string
          jsonPath: .status.phase
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
