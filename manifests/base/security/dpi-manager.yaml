apiVersion: v1
kind: ConfigMap
metadata:
  name: dpi-manager-config
  namespace: security
data:
  config.yaml: |
    manager:
      logLevel: info
      profiling: false
    
    suricata:
      enabled: true
      evePath: /var/log/suricata/eve.json
      mode: ids  # ids or ips
      rulesPath: /etc/suricata/rules
    
    zeek:
      enabled: true
      logsPath: /var/log/zeek
      scripts:
        - protocol-detection.zeek
        - file-extraction.zeek
    
    nprobe:
      enabled: true
      interface: eth0
      zmqPort: 5556
      samplingRate: 10
    
    integration:
      cilium:
        enabled: true
        policyGeneration: true
        dynamicUpdates: true
      
    profiles:
      - name: default
        description: "Default DPI profile for all traffic"
        enabled: true
        inspectionDepth: 2
        applications:
          - http
          - https
          - dns
          - ssh
        loggingEnabled: true
      
      - name: high-security
        description: "Deep inspection for sensitive traffic"
        enabled: true
        inspectionDepth: 3
        applications:
          - http
          - https
          - dns
          - smtp
          - ftp
          - ssh
          - database
        applicationCategories:
          - file-transfer
          - remote-access
        customSignatures:
          - name: suspicious-data-exfil
            description: "Detect suspicious data exfiltration"
            pattern: "POST.*password.*"
            protocol: http
        loggingEnabled: true
    
    flows:
      - description: "LAN to WAN inspection"
        enabled: true
        sourceNetwork: "192.168.1.0/24"
        destinationNetwork: "0.0.0.0/0"
        profile: default
      
      - description: "Server traffic inspection"
        enabled: true
        sourceNetwork: "10.0.0.0/8"
        destinationNetwork: "0.0.0.0/0"
        profile: high-security
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dpi-manager
  namespace: security
  labels:
    app: dpi-manager
    component: security
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dpi-manager
  template:
    metadata:
      labels:
        app: dpi-manager
        component: security
    spec:
      serviceAccountName: security-manager
      containers:
      - name: dpi-manager
        image: your-org/fos1-dpi-manager:latest
        imagePullPolicy: Always
        args:
          - "--config=/etc/dpi-manager/config.yaml"
          - "--logtostderr=true"
          - "--v=2"
        env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: SURICATA_SERVICE
          value: "suricata.security.svc.cluster.local"
        - name: ZEEK_SERVICE
          value: "zeek.security.svc.cluster.local"
        - name: CILIUM_API_SERVICE
          value: "cilium.network.svc.cluster.local:9234"
        resources:
          limits:
            cpu: 1000m
            memory: 1Gi
          requests:
            cpu: 200m
            memory: 512Mi
        volumeMounts:
        - name: config-volume
          mountPath: /etc/dpi-manager
        - name: suricata-logs
          mountPath: /var/log/suricata
        - name: zeek-logs
          mountPath: /var/log/zeek
        - name: rules-volume
          mountPath: /etc/rules
        ports:
        - containerPort: 8080
          name: http
        - containerPort: 9090
          name: metrics
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: config-volume
        configMap:
          name: dpi-manager-config
      - name: suricata-logs
        emptyDir: {}
      - name: zeek-logs
        emptyDir: {}
      - name: rules-volume
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: dpi-manager
  namespace: security
  labels:
    app: dpi-manager
    component: security
spec:
  selector:
    app: dpi-manager
  ports:
  - port: 8080
    targetPort: 8080
    name: http
  - port: 9090
    targetPort: 9090
    name: metrics
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: dpi-manager
rules:
- apiGroups: [""]
  resources: ["pods", "services", "endpoints", "namespaces"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["cilium.io"]
  resources: ["ciliumnetworkpolicies", "ciliumclusterwidenetworkpolicies"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["security.fos1.io"]
  resources: ["dpiprofiles", "dpiflows"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: dpi-manager
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: dpi-manager
subjects:
- kind: ServiceAccount
  name: security-manager
  namespace: security
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: security-manager
  namespace: security
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: dpiprofiles.security.fos1.io
spec:
  group: security.fos1.io
  names:
    kind: DPIProfile
    plural: dpiprofiles
    singular: dpiprofile
    shortNames:
    - dpi
  scope: Namespaced
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              description:
                type: string
              enabled:
                type: boolean
              inspectionDepth:
                type: integer
                minimum: 1
                maximum: 5
              applications:
                type: array
                items:
                  type: string
              applicationCategories:
                type: array
                items:
                  type: string
              trafficClasses:
                type: array
                items:
                  type: object
                  properties:
                    name:
                      type: string
                    applications:
                      type: array
                      items:
                        type: string
                    dscp:
                      type: integer
              customSignatures:
                type: array
                items:
                  type: object
                  properties:
                    name:
                      type: string
                    description:
                      type: string
                    pattern:
                      type: string
                    protocol:
                      type: string
              logging:
                type: object
                properties:
                  enabled:
                    type: boolean
                  logLevel:
                    type: string
                    enum: ["debug", "info", "warning", "error"]
              tlsInspection:
                type: object
                properties:
                  enabled:
                    type: boolean
                  exemptedHosts:
                    type: array
                    items:
                      type: string
    subresources:
      status: {}
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: dpiflows.security.fos1.io
spec:
  group: security.fos1.io
  names:
    kind: DPIFlow
    plural: dpiflows
    singular: dpiflow
  scope: Namespaced
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              description:
                type: string
              enabled:
                type: boolean
              sourceNetwork:
                type: string
              destinationNetwork:
                type: string
              profile:
                type: string
              bypassRules:
                type: array
                items:
                  type: object
                  properties:
                    match:
                      type: string
                    description:
                      type: string
              sampling:
                type: number
              priority:
                type: integer
    subresources:
      status: {}