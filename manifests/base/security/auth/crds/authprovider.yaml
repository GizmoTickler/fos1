apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: authproviders.security.fos1.io
spec:
  group: security.fos1.io
  names:
    kind: AuthProvider
    listKind: AuthProviderList
    plural: authproviders
    singular: authprovider
    shortNames:
      - authp
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - type
              properties:
                type:
                  type: string
                  description: "Type of authentication provider"
                  enum: ["local", "ldap", "oauth", "saml", "radius", "certificate"]
                enabled:
                  type: boolean
                  description: "Whether the provider is enabled"
                  default: true
                priority:
                  type: integer
                  description: "Priority of the provider"
                  minimum: 0
                  default: 0
                local:
                  type: object
                  description: "Configuration for local authentication"
                  properties:
                    passwordPolicy:
                      type: object
                      description: "Password policy"
                      properties:
                        minLength:
                          type: integer
                          description: "Minimum length of passwords"
                          minimum: 1
                          default: 8
                        requireUppercase:
                          type: boolean
                          description: "Whether passwords must contain uppercase letters"
                          default: true
                        requireLowercase:
                          type: boolean
                          description: "Whether passwords must contain lowercase letters"
                          default: true
                        requireNumbers:
                          type: boolean
                          description: "Whether passwords must contain numbers"
                          default: true
                        requireSpecial:
                          type: boolean
                          description: "Whether passwords must contain special characters"
                          default: true
                        maxAge:
                          type: integer
                          description: "Maximum age of passwords in days"
                          minimum: 0
                          default: 90
                        historyCount:
                          type: integer
                          description: "Number of previous passwords to remember"
                          minimum: 0
                          default: 5
                    mfaEnabled:
                      type: boolean
                      description: "Whether multi-factor authentication is enabled"
                      default: false
                    mfaMethods:
                      type: array
                      description: "Multi-factor authentication methods"
                      items:
                        type: string
                        enum: ["totp", "sms", "email", "push"]
                ldap:
                  type: object
                  description: "Configuration for LDAP authentication"
                  required:
                    - url
                    - userBaseDN
                  properties:
                    url:
                      type: string
                      description: "URL of the LDAP server"
                    bindDN:
                      type: string
                      description: "Bind DN for the LDAP server"
                    bindPassword:
                      type: string
                      description: "Bind password for the LDAP server"
                    userBaseDN:
                      type: string
                      description: "Base DN for users"
                    userFilter:
                      type: string
                      description: "Filter for users"
                      default: "(uid=%s)"
                    groupBaseDN:
                      type: string
                      description: "Base DN for groups"
                    groupFilter:
                      type: string
                      description: "Filter for groups"
                      default: "(objectClass=groupOfNames)"
                    groupMemberAttribute:
                      type: string
                      description: "Attribute for group members"
                      default: "member"
                    userAttributes:
                      type: object
                      description: "Attributes to retrieve for users"
                      additionalProperties:
                        type: string
                    startTLS:
                      type: boolean
                      description: "Whether to use StartTLS"
                      default: false
                    insecureSkipVerify:
                      type: boolean
                      description: "Whether to skip TLS verification"
                      default: false
                    caCert:
                      type: string
                      description: "CA certificate for TLS"
                oauth:
                  type: object
                  description: "Configuration for OAuth authentication"
                  required:
                    - providerType
                    - clientID
                    - clientSecret
                    - authorizationURL
                    - tokenURL
                    - userInfoURL
                    - redirectURL
                  properties:
                    providerType:
                      type: string
                      description: "Type of OAuth provider"
                      enum: ["google", "github", "microsoft", "okta", "auth0", "custom"]
                    clientID:
                      type: string
                      description: "Client ID"
                    clientSecret:
                      type: string
                      description: "Client secret"
                    authorizationURL:
                      type: string
                      description: "Authorization URL"
                    tokenURL:
                      type: string
                      description: "Token URL"
                    userInfoURL:
                      type: string
                      description: "User info URL"
                    redirectURL:
                      type: string
                      description: "Redirect URL"
                    scopes:
                      type: array
                      description: "Scopes to request"
                      items:
                        type: string
                    userIDAttribute:
                      type: string
                      description: "Attribute for user IDs"
                      default: "sub"
                    userAttributes:
                      type: object
                      description: "Attributes to retrieve for users"
                      additionalProperties:
                        type: string
                saml:
                  type: object
                  description: "Configuration for SAML authentication"
                  required:
                    - metadataURL
                    - entityID
                    - assertionConsumerServiceURL
                  properties:
                    metadataURL:
                      type: string
                      description: "URL of the SAML metadata"
                    entityID:
                      type: string
                      description: "Entity ID"
                    assertionConsumerServiceURL:
                      type: string
                      description: "Assertion consumer service URL"
                    signAuthnRequests:
                      type: boolean
                      description: "Whether to sign authentication requests"
                      default: true
                    signingCert:
                      type: string
                      description: "Signing certificate"
                    signingKey:
                      type: string
                      description: "Signing key"
                    encryptionCert:
                      type: string
                      description: "Encryption certificate"
                    encryptionKey:
                      type: string
                      description: "Encryption key"
                    userIDAttribute:
                      type: string
                      description: "Attribute for user IDs"
                      default: "NameID"
                    userAttributes:
                      type: object
                      description: "Attributes to retrieve for users"
                      additionalProperties:
                        type: string
                radius:
                  type: object
                  description: "Configuration for RADIUS authentication"
                  required:
                    - server
                    - secret
                  properties:
                    server:
                      type: string
                      description: "RADIUS server"
                    port:
                      type: integer
                      description: "RADIUS port"
                      minimum: 1
                      maximum: 65535
                      default: 1812
                    secret:
                      type: string
                      description: "RADIUS secret"
                    timeout:
                      type: integer
                      description: "Timeout in seconds"
                      minimum: 1
                      default: 5
                    retries:
                      type: integer
                      description: "Number of retries"
                      minimum: 0
                      default: 3
                    nasIdentifier:
                      type: string
                      description: "NAS identifier"
                certificate:
                  type: object
                  description: "Configuration for certificate authentication"
                  required:
                    - caCert
                  properties:
                    caCert:
                      type: string
                      description: "CA certificate"
                    userCertAttribute:
                      type: string
                      description: "Attribute for user certificates"
                      default: "subjectAltName"
                    userIDAttribute:
                      type: string
                      description: "Attribute for user IDs"
                      default: "CN"
                    verifyClient:
                      type: boolean
                      description: "Whether to verify the client"
                      default: true
                resources:
                  type: object
                  description: "Resource requirements"
                  properties:
                    limits:
                      type: object
                      properties:
                        cpu:
                          type: string
                          pattern: '^([0-9]+m|[0-9]+(\.[0-9]+)?)$'
                        memory:
                          type: string
                          pattern: '^([0-9]+(e[0-9]+)?|[0-9]+(\.[0-9]+)?(e[0-9]+)?[EPTGMK]i?)$'
                    requests:
                      type: object
                      properties:
                        cpu:
                          type: string
                          pattern: '^([0-9]+m|[0-9]+(\.[0-9]+)?)$'
                        memory:
                          type: string
                          pattern: '^([0-9]+(e[0-9]+)?|[0-9]+(\.[0-9]+)?(e[0-9]+)?[EPTGMK]i?)$'
                nodeSelector:
                  type: object
                  description: "Node selector for deployment"
                  additionalProperties:
                    type: string
            status:
              type: object
              properties:
                phase:
                  type: string
                  description: "Current phase of the provider"
                  enum: ["Pending", "Running", "Failed"]
                conditions:
                  type: array
                  description: "Current conditions of the provider"
                  items:
                    type: object
                    required:
                      - type
                      - status
                    properties:
                      type:
                        type: string
                        description: "Type of the condition"
                      status:
                        type: string
                        description: "Status of the condition"
                        enum: ["True", "False", "Unknown"]
                      reason:
                        type: string
                        description: "Reason for the condition"
                      message:
                        type: string
                        description: "Message for the condition"
                      lastTransitionTime:
                        type: string
                        format: date-time
                        description: "Last time the condition transitioned"
                userCount:
                  type: integer
                  description: "Number of users"
                groupCount:
                  type: integer
                  description: "Number of groups"
                lastSyncTime:
                  type: string
                  format: date-time
                  description: "Time of the last synchronization"
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Type
          type: string
          jsonPath: .spec.type
        - name: Enabled
          type: boolean
          jsonPath: .spec.enabled
        - name: Status
          type: string
          jsonPath: .status.phase
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
