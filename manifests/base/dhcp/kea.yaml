apiVersion: v1
kind: ConfigMap
metadata:
  name: kea-config
  namespace: network
data:
  kea-dhcp4.conf: |
    {
      "Dhcp4": {
        "interfaces-config": {
          "interfaces": [ "eth0" ]
        },
        "control-socket": {
          "socket-type": "unix",
          "socket-name": "/tmp/kea4-ctrl-socket"
        },
        "lease-database": {
          "type": "memfile",
          "persist": true,
          "name": "/var/lib/kea/dhcp4.leases"
        },
        "expired-leases-processing": {
          "reclaim-timer-wait-time": 10,
          "flush-reclaimed-timer-wait-time": 25,
          "hold-reclaimed-time": 3600,
          "max-reclaim-leases": 100,
          "max-reclaim-time": 250,
          "unwarned-reclaim-cycles": 5
        },
        "renew-timer": 900,
        "rebind-timer": 1800,
        "valid-lifetime": 3600,
        "option-data": [
          {
            "name": "domain-name-servers",
            "data": "192.168.1.1"
          },
          {
            "name": "routers",
            "data": "192.168.1.1"
          }
        ],
        "subnet4": [
          {
            "subnet": "192.168.1.0/24",
            "pools": [ { "pool": "192.168.1.100 - 192.168.1.200" } ],
            "option-data": [
              {
                "name": "domain-name",
                "data": "local"
              }
            ]
          }
        ],
        "loggers": [
          {
            "name": "kea-dhcp4",
            "output_options": [
              {
                "output": "stdout",
                "pattern": "%-5p %m\n"
              }
            ],
            "severity": "INFO"
          }
        ]
      }
    }
  kea-dhcp6.conf: |
    {
      "Dhcp6": {
        "interfaces-config": {
          "interfaces": [ "eth0" ]
        },
        "control-socket": {
          "socket-type": "unix",
          "socket-name": "/tmp/kea6-ctrl-socket"
        },
        "lease-database": {
          "type": "memfile",
          "persist": true,
          "name": "/var/lib/kea/dhcp6.leases"
        },
        "preferred-lifetime": 3000,
        "valid-lifetime": 4000,
        "renew-timer": 1000,
        "rebind-timer": 2000,
        "subnet6": [
          {
            "subnet": "2001:db8:1::/64",
            "pools": [ { "pool": "2001:db8:1::100 - 2001:db8:1::ffff" } ],
            "option-data": [
              {
                "name": "dns-servers",
                "data": "2001:db8:1::1"
              }
            ]
          }
        ],
        "loggers": [
          {
            "name": "kea-dhcp6",
            "output_options": [
              {
                "output": "stdout",
                "pattern": "%-5p %m\n"
              }
            ],
            "severity": "INFO"
          }
        ]
      }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kea-dhcp
  namespace: network
  labels:
    app: kea-dhcp
    component: dhcp
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kea-dhcp
  template:
    metadata:
      labels:
        app: kea-dhcp
        component: dhcp
    spec:
      hostNetwork: true
      containers:
      - name: kea-dhcp4
        image: internetsystemsconsortium/kea:2.4.0
        command: ["/usr/sbin/kea-dhcp4", "-c", "/etc/kea/kea-dhcp4.conf"]
        resources:
          limits:
            cpu: 200m
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 128Mi
        volumeMounts:
        - name: config-volume
          mountPath: /etc/kea
        - name: data-volume
          mountPath: /var/lib/kea
      - name: kea-dhcp6
        image: internetsystemsconsortium/kea:2.4.0
        command: ["/usr/sbin/kea-dhcp6", "-c", "/etc/kea/kea-dhcp6.conf"]
        resources:
          limits:
            cpu: 200m
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 128Mi
        volumeMounts:
        - name: config-volume
          mountPath: /etc/kea
        - name: data-volume
          mountPath: /var/lib/kea
      volumes:
      - name: config-volume
        configMap:
          name: kea-config
      - name: data-volume
        emptyDir: {}