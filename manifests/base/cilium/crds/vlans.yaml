apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: vlans.networking.fos1.io
spec:
  group: networking.fos1.io
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required: ["id", "interface"]
              properties:
                id:
                  type: integer
                  description: "VLAN ID (1-4094)"
                  minimum: 1
                  maximum: 4094
                interface:
                  type: string
                  description: "Parent interface for this VLAN"
                name:
                  type: string
                  description: "Human-readable name for this VLAN"
                address:
                  type: string
                  description: "IP address with CIDR notation for this VLAN interface"
                  pattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(3[0-2]|[1-2][0-9]|[0-9]))$"
                mtu:
                  type: integer
                  description: "MTU for this VLAN interface"
                  minimum: 576
                  maximum: 9000
                enabled:
                  type: boolean
                  description: "Whether this VLAN is enabled"
                  default: true
                dhcpEnabled:
                  type: boolean
                  description: "Whether DHCP is enabled on this VLAN"
                  default: false
                dhcpRange:
                  type: object
                  description: "DHCP range configuration"
                  properties:
                    start:
                      type: string
                      description: "Start IP address for DHCP range"
                      pattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$"
                    end:
                      type: string
                      description: "End IP address for DHCP range"
                      pattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$"
                vxlanId:
                  type: integer
                  description: "VXLAN ID for overlay networking"
                  minimum: 1
                  maximum: 16777215
                routes:
                  type: array
                  description: "Network routes for this VLAN"
                  items:
                    type: object
                    required: ["destination"]
                    properties:
                      destination:
                        type: string
                        description: "Destination network in CIDR format"
                      gateway:
                        type: string
                        description: "Next-hop gateway for this route"
                      metric:
                        type: integer
                        description: "Route metric (priority)"
                        minimum: 1
                zone:
                  type: string
                  description: "Security zone for this VLAN (e.g., LAN, WAN, DMZ)"
                ebpfPrograms:
                  type: array
                  description: "eBPF programs to attach to this VLAN interface"
                  items:
                    type: object
                    required: ["name", "type"]
                    properties:
                      name:
                        type: string
                        description: "Name of the eBPF program"
                      type:
                        type: string
                        description: "Type of attachment (XDP, TC ingress, TC egress)"
                        enum: ["xdp", "tc-ingress", "tc-egress"]
                      priority:
                        type: integer
                        description: "Priority for TC programs"
                vtepEnabled:
                  type: boolean
                  description: "Whether VTEP is enabled for this VLAN"
                  default: false
                vtepRemoteIPs:
                  type: array
                  description: "Remote VTEP IP addresses for this VLAN"
                  items:
                    type: string
                    pattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$"
            status:
              type: object
              properties:
                phase:
                  type: string
                  description: "Current phase of the VLAN (Pending, Active, Failed)"
                  enum: ["Pending", "Active", "Failed"]
                actualInterfaceName:
                  type: string
                  description: "Actual interface name in the system"
                activeAddresses:
                  type: array
                  description: "Active IP addresses on this VLAN"
                  items:
                    type: string
                dhcpLeaseCount:
                  type: integer
                  description: "Number of active DHCP leases"
                error:
                  type: string
                  description: "Error message if failed"
                lastUpdate:
                  type: string
                  format: date-time
                  description: "Last update timestamp"
      additionalPrinterColumns:
      - name: ID
        type: integer
        jsonPath: .spec.id
      - name: Interface
        type: string
        jsonPath: .spec.interface
      - name: Address
        type: string
        jsonPath: .spec.address
      - name: Status
        type: string
        jsonPath: .status.phase
      - name: Age
        type: date
        jsonPath: .metadata.creationTimestamp
  scope: Namespaced
  names:
    plural: vlans
    singular: vlan
    kind: VLAN
    shortNames:
    - vl
