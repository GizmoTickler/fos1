apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: ntpservices.ntp.fos1.io
spec:
  group: ntp.fos1.io
  names:
    kind: NTPService
    listKind: NTPServiceList
    plural: ntpservices
    singular: ntpservice
    shortNames:
      - ntp
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - enabled
              properties:
                enabled:
                  type: boolean
                  description: "Whether the NTP service is enabled"
                sources:
                  type: object
                  properties:
                    pools:
                      type: array
                      items:
                        type: object
                        required:
                          - name
                        properties:
                          name:
                            type: string
                            description: "NTP pool name (e.g., pool.ntp.org)"
                          servers:
                            type: integer
                            description: "Maximum number of servers to use from this pool"
                            default: 4
                            minimum: 1
                            maximum: 16
                          iburst:
                            type: boolean
                            description: "Whether to use iburst option for faster synchronization"
                            default: true
                          prefer:
                            type: boolean
                            description: "Whether to prefer this source over others"
                            default: false
                    servers:
                      type: array
                      items:
                        type: object
                        required:
                          - address
                        properties:
                          address:
                            type: string
                            description: "NTP server address"
                          iburst:
                            type: boolean
                            description: "Whether to use iburst option for faster synchronization"
                            default: true
                          prefer:
                            type: boolean
                            description: "Whether to prefer this source over others"
                            default: false
                          minpoll:
                            type: integer
                            description: "Minimum poll interval (log2 seconds)"
                            minimum: 3
                            maximum: 17
                          maxpoll:
                            type: integer
                            description: "Maximum poll interval (log2 seconds)"
                            minimum: 3
                            maximum: 17
                    hardware:
                      type: object
                      properties:
                        pps:
                          type: object
                          properties:
                            enabled:
                              type: boolean
                              description: "Whether to use PPS (Pulse Per Second) source"
                              default: false
                            device:
                              type: string
                              description: "PPS device path"
                            prefer:
                              type: boolean
                              description: "Whether to prefer this source over others"
                              default: true
                        gps:
                          type: object
                          properties:
                            enabled:
                              type: boolean
                              description: "Whether to use GPS as a time source"
                              default: false
                            device:
                              type: string
                              description: "GPS device path"
                            refclock:
                              type: boolean
                              description: "Whether to use as a reference clock"
                              default: true
                            prefer:
                              type: boolean
                              description: "Whether to prefer this source over others"
                              default: true
                server:
                  type: object
                  properties:
                    stratum:
                      type: integer
                      description: "Stratum level when operating as a server"
                      minimum: 1
                      maximum: 15
                      default: 10
                    driftfile:
                      type: string
                      description: "Path to the drift file"
                      default: "/var/lib/chrony/drift"
                    makestep:
                      type: object
                      properties:
                        threshold:
                          type: number
                          description: "Step threshold in seconds"
                          default: 1.0
                        limit:
                          type: integer
                          description: "Maximum number of steps"
                          default: 3
                    local:
                      type: object
                      properties:
                        enabled:
                          type: boolean
                          description: "Whether to enable local reference clock"
                          default: false
                        stratum:
                          type: integer
                          description: "Stratum for local reference clock"
                          minimum: 1
                          maximum: 15
                          default: 10
                security:
                  type: object
                  properties:
                    nts:
                      type: object
                      properties:
                        enabled:
                          type: boolean
                          description: "Whether to enable Network Time Security"
                          default: false
                    authentication:
                      type: object
                      properties:
                        enabled:
                          type: boolean
                          description: "Whether to enable authentication"
                          default: false
                        keys:
                          type: array
                          items:
                            type: object
                            required:
                              - id
                              - type
                              - value
                            properties:
                              id:
                                type: integer
                                description: "Key ID"
                                minimum: 1
                              type:
                                type: string
                                description: "Key type (MD5, SHA1, SHA256, SHA512)"
                                enum: ["MD5", "SHA1", "SHA256", "SHA512"]
                              value:
                                type: string
                                description: "Key value"
                    ratelimit:
                      type: object
                      properties:
                        enabled:
                          type: boolean
                          description: "Whether to enable rate limiting"
                          default: true
                        interval:
                          type: integer
                          description: "Rate limit interval in seconds"
                          default: 3
                        burst:
                          type: integer
                          description: "Rate limit burst"
                          default: 8
                    access:
                      type: array
                      items:
                        type: object
                        required:
                          - network
                          - permission
                        properties:
                          network:
                            type: string
                            description: "Network in CIDR notation"
                          permission:
                            type: string
                            description: "Permission (allow, deny)"
                            enum: ["allow", "deny"]
                vlanConfig:
                  type: array
                  items:
                    type: object
                    required:
                      - vlanRef
                      - enabled
                    properties:
                      vlanRef:
                        type: string
                        description: "Reference to a VLAN"
                      enabled:
                        type: boolean
                        description: "Whether NTP is enabled on this VLAN"
                      broadcast:
                        type: boolean
                        description: "Whether to enable NTP broadcast on this VLAN"
                        default: false
                      clientsOnly:
                        type: boolean
                        description: "Whether to allow only client operations on this VLAN"
                        default: true
                monitoring:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      description: "Whether to enable monitoring"
                      default: true
                    offset:
                      type: object
                      properties:
                        warningThreshold:
                          type: integer
                          description: "Warning threshold for offset in milliseconds"
                          default: 100
                        criticalThreshold:
                          type: integer
                          description: "Critical threshold for offset in milliseconds"
                          default: 500
                    sourcesMinimum:
                      type: integer
                      description: "Minimum number of sources required"
                      default: 2
            status:
              type: object
              properties:
                running:
                  type: boolean
                  description: "Whether the NTP service is running"
                synchronized:
                  type: boolean
                  description: "Whether the NTP service is synchronized"
                stratum:
                  type: integer
                  description: "Current stratum level"
                offset:
                  type: number
                  description: "Current offset in milliseconds"
                jitter:
                  type: number
                  description: "Current jitter in milliseconds"
                sourceCount:
                  type: integer
                  description: "Number of time sources"
                lastError:
                  type: string
                  description: "Last error message"
                lastErrorTime:
                  type: string
                  format: date-time
                  description: "Time of the last error"
                conditions:
                  type: array
                  items:
                    type: object
                    required:
                      - type
                      - status
                    properties:
                      type:
                        type: string
                        description: "Condition type"
                      status:
                        type: string
                        description: "Condition status"
                      reason:
                        type: string
                        description: "Reason for the condition"
                      message:
                        type: string
                        description: "Message for the condition"
                      lastTransitionTime:
                        type: string
                        format: date-time
                        description: "Last transition time"
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Enabled
          type: boolean
          jsonPath: .spec.enabled
        - name: Synchronized
          type: boolean
          jsonPath: .status.synchronized
        - name: Stratum
          type: integer
          jsonPath: .status.stratum
        - name: Offset
          type: number
          jsonPath: .status.offset
          format: float
        - name: Sources
          type: integer
          jsonPath: .status.sourceCount
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
