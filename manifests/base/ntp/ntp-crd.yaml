apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: ntpservices.ntp.fos1.io
spec:
  group: ntp.fos1.io
  names:
    kind: NTPService
    plural: ntpservices
    singular: ntpservice
    shortNames:
      - ntp
  scope: Namespaced
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        required:
          - spec
        properties:
          spec:
            type: object
            required:
              - enabled
              - sources
              - server
            properties:
              enabled:
                type: boolean
              sources:
                type: object
                properties:
                  pools:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        servers:
                          type: integer
                          minimum: 1
                          maximum: 16
                        iburst:
                          type: boolean
                          default: true
                        prefer:
                          type: boolean
                          default: false
                  servers:
                    type: array
                    items:
                      type: object
                      properties:
                        address:
                          type: string
                        iburst:
                          type: boolean
                          default: true
                        prefer:
                          type: boolean
                          default: false
                        minpoll:
                          type: integer
                          minimum: 3
                          maximum: 17
                          default: 6
                        maxpoll:
                          type: integer
                          minimum: 3
                          maximum: 17
                          default: 10
                  hardware:
                    type: object
                    properties:
                      pps:
                        type: object
                        properties:
                          enabled:
                            type: boolean
                            default: false
                          device:
                            type: string
                            default: "/dev/pps0"
                          prefer:
                            type: boolean
                            default: true
                      gps:
                        type: object
                        properties:
                          enabled:
                            type: boolean
                            default: false
                          device:
                            type: string
                            default: "/dev/ttyS0"
                          refclock:
                            type: boolean
                            default: true
                          prefer:
                            type: boolean
                            default: true
              server:
                type: object
                properties:
                  stratum:
                    type: integer
                    minimum: 1
                    maximum: 15
                    default: 2
                  driftfile:
                    type: string
                    default: "/var/lib/chrony/drift"
                  makestep:
                    type: object
                    properties:
                      threshold:
                        type: number
                        minimum: 0.001
                        default: 1.0
                      limit:
                        type: integer
                        minimum: 0
                        default: 3
                  local:
                    type: object
                    properties:
                      enabled:
                        type: boolean
                        default: true
                      stratum:
                        type: integer
                        minimum: 1
                        maximum: 15
                        default: 10
              security:
                type: object
                properties:
                  nts:
                    type: object
                    properties:
                      enabled:
                        type: boolean
                        default: false
                  authentication:
                    type: object
                    properties:
                      enabled:
                        type: boolean
                        default: false
                      keys:
                        type: array
                        items:
                          type: object
                          required:
                            - id
                            - type
                            - value
                          properties:
                            id:
                              type: integer
                              minimum: 1
                            type:
                              type: string
                              enum: ["MD5", "SHA1", "SHA256", "SHA384", "SHA512"]
                            value:
                              type: string
                  ratelimit:
                    type: object
                    properties:
                      enabled:
                        type: boolean
                        default: true
                      interval:
                        type: integer
                        minimum: 1
                        default: 3
                      burst:
                        type: integer
                        minimum: 1
                        default: 8
                  access:
                    type: array
                    items:
                      type: object
                      required:
                        - network
                        - permission
                      properties:
                        network:
                          type: string
                        permission:
                          type: string
                          enum: ["allow", "deny"]
              vlanConfig:
                type: array
                items:
                  type: object
                  required:
                    - vlanRef
                    - enabled
                  properties:
                    vlanRef:
                      type: string
                    enabled:
                      type: boolean
                    broadcast:
                      type: boolean
                      default: false
                    clientsOnly:
                      type: boolean
                      default: false
              monitoring:
                type: object
                properties:
                  enabled:
                    type: boolean
                    default: true
                  offset:
                    type: object
                    properties:
                      warningThreshold:
                        type: integer
                        minimum: 1
                        default: 100
                      criticalThreshold:
                        type: integer
                        minimum: 1
                        default: 1000
                  sourcesMinimum:
                    type: integer
                    minimum: 1
                    default: 3
    additionalPrinterColumns:
    - name: Enabled
      type: boolean
      jsonPath: .spec.enabled
    - name: Status
      type: string
      jsonPath: .status.syncStatus
    - name: Sources
      type: integer
      jsonPath: .status.sourceCount
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp
    subresources:
      status: {}